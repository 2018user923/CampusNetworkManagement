<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>
    <!--[if IE]>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <![endif]-->
    <title></title>
    <!-- BOOTSTRAP CORE STYLE  -->
    <link th:href="@{/assets/css/bootstrap.css}" rel="stylesheet"/>
    <!-- FONT AWESOME STYLE  -->
    <link th:href="@{/assets/css/font-awesome.css}" rel="stylesheet"/>
    <!-- CUSTOM STYLE  -->
    <link th:href="@{/assets/css/style.css}" rel="stylesheet"/>
    <!-- GOOGLE FONT -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'/>

</head>
<body>
<div th:replace="commons/common ::LOGO_HEADER_TOP"></div>
<div th:replace="commons/common ::LOGO_HEADER_END"></div>

<!-- MENU SECTION END-->
<div class="content-wrapper">
    <div class="container">
        <div class="row pad-botm">
            <div class="col-md-12">
                <h4 class="header-line">个人信息</h4>
            </div>
        </div>
        <div class="row" id="userInfoUpdate">
            <div class="col-md-6 col-sm-6 col-xs-12">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        <img class="media-object img-circle img-comments" alt="个人头像" ref="avatarUrl"
                             src=""/>
                    </div>
                    <div class="panel-body">
                        <form>
                            <div class="form-group">
                                <label>{{userNameText}}</label>
                                <input class="form-control" type="text" v-model="userName" :disabled="isDisabled"/>
                            </div>
                            <div class="form-group">
                                <label>{{idCardText}}</label>
                                <input class="form-control" type="text" v-model="idCard" :disabled="isDisabled"
                                       @blur="checkIdCard"/>
                            </div>
                            <div class="form-group">
                                <label>{{emailText}}</label>
                                <input class="form-control" type="text" v-model="email" :disabled="isDisabled"
                                       @blur="checkEmail"/>
                            </div>
                            <div class="form-group">
                                <label>{{passWordText}}</label>
                                <input class="form-control" type="password" v-model="passWord" :disabled="isDisabled"
                                       @focus="changeText" @blur="changePassWord"/>
                            </div>
                            <div class="form-group">
                                <label>{{phoneText}}</label>
                                <input class="form-control" type="text" v-model="phone" :disabled="isDisabled"
                                       @blur="checkPhone"/>
                            </div>
                            <div class="form-group">
                                <input type="file" accept="image/jpeg, image/png, image/gif" ref="upfile"
                                       :disabled="isDisabled">
                            </div>
                            <button type="submit" class="btn btn-info" @click.prevent="userInfoUpdateClick"
                                    :disabled="isDisabled">更新
                            </button>
                            <button class="btn btn-info" @click.prevent="isDisabled = !isDisabled">查看修改</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-sm-6 col-xs-12">
                <iframe src="http://localhost:8080/chatting" frameborder="0" width="600" height="800">
                </iframe>
            </div>
        </div>
    </div>
</div>


<script th:src="@{/vueResources/tools/axios.js}"></script>
<script th:src="@{/vueResources/tools/vue.js}"></script>
<script th:inline="javascript">
    new Vue({
        el: '#userInfoUpdate',
        //可编辑
        data: {
            userName: null,
            idCard: null,
            email: null,
            passWord: null,
            phone: null,
            balance: null,
            avatarUrl: null,
            //如果为 true，表示不可编辑
            isDisabled: true,

            userNameText: '用户名',
            idCardText: '身份证',
            emailText: '邮箱',
            passWordText: '密码',
            phoneText: '手机号'
        },
        methods: {
            userInfoUpdateClick() {
                let params = new FormData()
                let file = this.$refs.upfile.files[0]
                params.append("userName", this.userName)
                params.append("idCard", this.idCard)
                params.append("email", this.email)
                params.append("passWord", this.passWord)
                params.append("phone", this.phone)
                params.append("file", file)
                axios.post('http://localhost:8080/userInfoUpdateSubmit', params).then(rep => {
                    if (rep.data.code === 200) {
                        alert('个人信息更新成功！')
                        this.getUserInfo()
                    } else {
                        alert('未知原因更新失败！' + rep.data)
                    }
                }).catch(err => {
                    alert(err)
                })
            },
            getUserInfo() {
                axios.post('http://localhost:8080/getUserInfo').then(rep => {
                    this.userName = rep.data.userName
                    this.idCard = rep.data.idCard
                    this.email = rep.data.email
                    this.passWord = rep.data.passWord
                    this.phone = rep.data.phone
                    this.balance = rep.data.balance
                    this.avatarUrl = rep.data.avatar
                    this.$refs.avatarUrl.setAttribute("src", this.avatarUrl)
                }).catch(err => {
                    console.log(err);
                })
            },
            changeText(even) {
                even.target.setAttribute('type', 'text')

            },
            changePassWord(even) {
                even.target.setAttribute('type', 'password')
            },
            checkEmail() {
                let regex = /^[A-Za-zd0-9]+([-_.][A-Za-zd]+)*@([A-Za-zd]+[-.])+[A-Za-zd]{2,5}$/;
                if (!regex.test(this.email)) {
                    this.emailText = '邮箱格式不正确，请修改！'
                    return false
                } else {
                    this.emailText = '邮箱'
                    return true
                }
            },
            checkPhone() {
                let regex = /^1[3|4|5|7|8]\d{9}$/
                if (!(regex.test(this.phone))) {
                    this.phoneText = '手机号码格式不正确，请修改！'
                    return false
                } else {
                    this.phoneText = '手机号'
                    return true
                }
            },
            checkIdCard() {
                let regex = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
                if (!(regex.test(this.idCard))) {
                    this.idCardText = '身份证号码格式不正确，请修改！'
                    return false
                } else {
                    this.idCardText = '身份证'
                    return true
                }
            }
        },
        mounted() {
            this.getUserInfo()
        }
    })
</script>


<div th:replace="commons/common ::CONTENT-WRAPPER_SECTION_END"></div>
<!-- CORE JQUERY  -->
<script src="assets/js/jquery-1.10.2.js"></script>
<!-- BOOTSTRAP SCRIPTS  -->
<script src="assets/js/bootstrap.js"></script>
<!-- CUSTOM SCRIPTS  -->
<script src="assets/js/custom.js"></script>
</body>
</html>
